= Quarkus OAuth2/OIDC Proxy for NGINX
:toc: left
:icons: font
:source-highlighter: highlight.js

== Overview
This Quarkus application provides OAuth2/OpenID Connect authentication for NGINX, leveraging a stateless cookie-based approach to ensure secure and scalable authentication without relying on server-side sessions.

=== REST Endpoints

* */auth/login*: Initiates the OpenID Connect (OIDC) authentication flow.
* */auth/callback*: Processes the response from the Identity Provider (IDP) and generates the authentication cookie.
* */auth/validate*: Verifies the token from the authentication cookie (used by NGINX via the `auth_request` directive).
* */auth/logout*: Deletes the authentication cookie to log the user out.
* *auth/.well-known/jwks.json*: Supplies OIDC discovery metadata for dynamic client registration.

=== NGINX Integration

The provided NGINX configuration leverages the `auth_request` directive to authenticate requests against the `/auth/validate` endpoint. It forwards the validated JWT token to backend services for further processing.

== Provider Compatibility

The application works with any OAuth2/OpenID Connect provider by setting the appropriate configuration in `application.yaml`. The design is completely stateless, storing all authentication information in cookies without using server-side sessions.

To configure for a specific provider (like Google, EntraID, etc.), you only need to update the OIDC configuration variables in the YAML file or set the corresponding environment variables.

== Configuration

=== Environment Variables

==== General Settings

STATE_SECRET:: Secret used to secure the state parameter in OIDC flows. Use a strong random value.

==== Cookie Settings

COOKIE_NAME:: Name of the authentication cookie (default: `AUTH_TOKEN`).
COOKIE_PATH:: Path for the authentication cookie (default: `/`).
COOKIE_DOMAIN:: Domain for the authentication cookie.
COOKIE_SECURE:: Whether the cookie is secure (default: `true`).
COOKIE_HTTP_ONLY:: Whether the cookie is HTTP-only (default: `true`).
COOKIE_SAME_SITE:: SameSite attribute for the cookie (default: `Lax`).
COOKIE_MAX_AGE:: Maximum age of the cookie (default: `24h`).

==== Federated IDP Settings

OIDC_FEDERATION_MODE:: Federation mode (valid values: `FEDERATE_FROM_ID_TOKEN`, `FEDERATE_FROM_ACCESS_TOKEN`, `PASS_TROUGH`; default: `FEDERATE_FROM_ID_TOKEN`).
OIDC_DISCOVERY_ENABLED:: Whether OIDC discovery is enabled (default: true).
OIDC_AUTH_SERVER_URL:: Base URL of the authorization server.
OIDC_DISCOVERY_PATH:: Path for OIDC discovery (default: `.well-known/openid-configuration`).
OIDC_TOKEN_PATH:: Path for token requests.
OIDC_AUTHORIZATION_PATH:: Path for authorization requests.
OIDC_JWKS_PATH:: Path for JWKS (JSON Web Key Set).
OIDC_USERINFO_PATH:: Path for user info requests.
OIDC_END_SESSION_PATH:: Path for logout requests.

OIDC_ISSUER:: Issuer name for the federated IDP.
OIDC_AUDIENCE:: Audience for the federated IDP.
OIDC_CLIENT_ID:: Client ID for the OIDC provider.
OIDC_CLIENT_SECRET:: Client secret for the OIDC provider.
OIDC_SCOPE:: Scope for OIDC requests (default: `openid profile email`).
OIDC_REDIRECT_URL:: Redirect URI for the application.

==== Internal Issuer Settings

OIDC_INTERNAL_ISSUER:: Issuer name for the internal token generator.
OIDC_PASS_THROUGH_CLAIMS:: List of claims to pass through from the ID token (default: `roles,email,given_name,family_name,name`).

OIDC_INTERNAL_ISSUER_KEY_ID:: Key ID for the internal issuer signing key.
OIDC_INTERNAL_ISSUER_SIGNATURE_ALGORITHM:: Signature algorithm for the internal issuer (default: `ES256`).
OIDC_INTERNAL_ISSUER_PRIVATE_KEY:: Private key for signing tokens.
OIDC_INTERNAL_ISSUER_PUBLIC_KEY:: Public key for verifying tokens.

==== Token Forwarding Settings

OIDC_TOKEN_HEADER_NAME:: Name of the header for forwarding the token (default: `X-Auth-Token`).
OIDC_TOKEN_FORWARDING_METHOD:: Method for forwarding the token (`HEADER` or `BEARER`, default: `HEADER`).

== Generate Private and Public Keys

=== Generate ES256 Keys

[source, bash]
----
openssl ecparam -genkey -name prime256v1 -noout -out private_key.pem
openssl pkcs8 -topk8 -inform PEM -outform PEM -in private_key.pem -out private_key_pkcs8.pem -nocrypt
openssl ec -in private_key.pem -pubout -out public_key.pem
cat private_key_pkcs8.pem
cat public_key.pem
----